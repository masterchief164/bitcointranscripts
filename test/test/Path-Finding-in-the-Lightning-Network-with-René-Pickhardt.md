---
title: Path Finding in the Lightning Network with Ren√© Pickhardt
transcript_by: masterchief164 via TBTBTC v1.0.0
media: https://www.youtube.com/watch?v=NT_dMqB1xuA
date: 2021-08-19

---

## Path finding on the Lightning Network (gossip)

 And now today I'm going to talk a little bit about path finding on the lighting network and some part of it will be about the gossip protocol which is like a little bit of a review of what the gossip messages are going to look like. So it's a little bit basic again, but other than that I've been told that you seek more for like opinionated talks and recent ideas instead of like how the bolts work because you already know all of that so I'm trying to go a little bit more in this direction. Yet I'm still an educator so we're going to do a little bit of education. So the outline is I will start with a quick recap of the 2018 lighting residency as I was resident at that time so I thought I shared a little bit of my experience with you. Then I'm going to compare IP routing with routing on the lightning network. Christian already mentioned a couple of things on that. Then I will go through the motivation of why our finding is actually a difficult problem on the lighting network and then I go to talk about actual path finding strategies. And a little bit more gossip and that will go to the outline. Actually I haven't the outline but I was shifting topics so yeah. So yeah this was the picture of last year's lighting residency so the quick recap goes like this. It started with Christian explaining me that routing is a hard problem and then there was Elaine who actually told me that routing impact is always fails and then we had Christian again who explained me that routing can be difficult and relies on channels and capacity and PSBing online. And then there was Jake Malers who if you read it correctly was talking about auto pilots and the channels won't be relevant so so he touched this topic of this is difficult. And this is what I got out of the residency that routing has some back problem. As we discussed yesterday this is plain wrong. Routing has been solved on the lightning network. It's actually path finding that it's the hard problem so I want to be a little bit more precise on the terminology that I'm trying to use in this talk. So the good thing is I want you. I want you because these are open problems and you can make a huge difference on them. I would currently say that we don't have a working solution for path finding on the lightning network. There's many proposals out. We already seen some yesterday and I will hold a little bit through them again today. So especially for these people staying in the summer and wanting to work on lightning I think this is a great opportunity because there is also, yeah really the chance to make a huge difference. So I want to motivate you to think about these problems. All right. Right. This is not working. Okay. I just use this one. So as I promised before like really going into path finding let's compare IP routing with on your routing in order to understand this. So let's do a quick recap of how IP routing works. I think most people are familiar with this. The load processes the IP header of the IP package that it receives and then it extracts the sender and the recipient of this package. Actually it would not necessarily need the sender for forwarding it only for response and IP. And then it dissects the IP address of the recipient into the network part and the network part, you know it's usually the first upload digits or bits. And it's a hierarchical address scheme, right, which the network uses for making routing decisions. And then there's the host part of it. And a router looks up the network part and it's routing table and the network is known that it sends the link to the package to the next link by the link layer protocols of example. If a net or DSL or whatever link layer protocol is implemented and otherwise it will send it to its default route, which is something like hey you probably know better how to handle this. But this is pretty much how IP routing works. And the routing tables themselves there dynamically updated. For example, via the border gate by protocol I think there's several variations of those. But there is basically some communication among internet holes and internet routers that basically talk to each other all the time and share information about the topology of the network of where networks are located and then they can make decisions of where to forward this package. And the concept how I always call it is called best effort routing, which is to always use the word distance vector routing. I think that's in computer science terms, the more precise term. But as you can see from my short item, math, mathematicians. So these forgive me and I would say this is an amazingly strong concept. I mean, think about it. The internet is just running all the time. If you talk to the people who came up with PCPIP, I think maybe they were just humble. But what they usually say is we didn't expect this to scale that much. They were doing just a research project for university and then it took often people were just implementing and building on top of it. And I mean basically, yes, we had this address based in Lemmer, but to some degree it's scaled to infinity. It's one of the strongest tables computer systems that we currently have. And I just want to make it one last time like explicit of how it really works. Like there is the address of the IP package that states, I want to go to chain code labs and what the router does is it says, oh yeah, that's in New York because this is what it reads from the host part. And then it says, I sent you along this road because this gets you closer to New York, ask again later. And then you go to the next crossway or next router, then you can repeat the process basis. This is how information is being sent on IP. And this is actually path finding right, and that's where we find the path.

## Comparing IP Routing with Onion Routing

 So I want to compare IP routing with onion routing, or at least with onion routing, how we use it in the lighting effect. So the first type, as we already mentioned, an IP routing we have, this method of called best effort routing, because every router basically has its best effort to say the best thing I can do is tend to along this road. Where in onion routing, as we discussed several times, we have the source-based routing, the sender has to make all the decisions about what path to use. And then the data format is very different, because in IP, we have open headers. Everybody along the path can read the header information, whereas in lightning, we basically have encrypted headers. There's only a small part of the header that gives a hint of what you should do at your hop, but the rest of the entire information is encrypted, and the hidden away from you. The sender and the recipient are known to the routing node, so they can use this information to help with the routing to make decisions, whereas in onion routing, I think it was for Brisius today, who is really, I think, some people already mentioned it to me, and for me it was also eye-opening of saying, it's really funny the routing nodes don't actually need the gossip protocol and the gossip store to some degree, because they are just going to forward the package anyway to their peers. They don't even have to be aware of the technology of the network. And then in IP routing, we have an address space that is logical and hierarchical overlay network. And to some degree, I would argue it reflects some geographical properties. I mean, the IP network, that you usually have are usually located in some direction. It doesn't have to be like this, but usually when you make requests, you route geographically in your country or in your region, you don't necessarily go over China, unless you do something like for arsenal. Whereas in the lightning network, it's really a fully decentralized peer-to-peer network. The addresses are just public. He's a perfect point right there. They don't give you any information of that, and we don't have this address space in that sense. Then when you talk about the edge rates of the network, in IP, I would argue that they're mostly static, you have the bandwidth of the links that are basically the information that you need for routing, a package arrives, and then you say, oh, I can actually forward it on this link, or this is what you could use to make routing decisions. If you look at the routing table protocols, they might use to say, hey, this is less hops, but the hops are really slow, so I'd rather take a longer route where I can actually push through traffic, whereas in lightning, it gets really strange with the edge rates. It's first of all, not even clear what to put on the edge rate, but I would argue it's highly dynamic. That the piece can change or another edge rate, it's edge rate that you should use for routing is actually the balance. How much money is in this channel? And not in the channel, but on your side of the channel, because that's the only, that's necessary condition to be able to forward a package, right? And this thing is changing all the time with every routing process, this thing gets updated. So if you think about the topology and information propagation, the network in IP can react to changes of the topology pretty well. So we have this border gate rate protocol and if some route are fails, or if we just switch some cables, routing tables are being updated, it takes some time, but since the network is full, to all the run, we might find some other routes, it's still working pretty well. If we look again at this like fully decentralized peer-to-peer network, we have a gossip protocol, which is rather slow, it's noisy to propagate all relevant information. So for example, if you think about the balance, let's consider we ignore privacy for a moment, and we just want to propagate the balance of all the channels at all the time. This would be a mess because it's changing with every payment process. So it technically is not probably not even possible to achieve this, right? But then again, we want to have privacy, so we might not even want to share this information. So this entire topology and information about how the network looks like enlightening, we don't have this. Then if you think about the Nile of Service Attacks, in TCPIP, you can do spoofing. I mean, I can just send out an IP package and say it comes from a certain sender, and then the nodes will reply to this. Since everything is open, since we have open headers, the ISPs can actually monitor some behavior like this and can interfere with this and can mitigate these attacks, whereas enlightening everybody or anyone can just send and delay onions. And this is pretty much impossible for us to detect or to mitigate. So if you're running a lightning node, and I want to be nasty, I just got to send some onions away. Don't put a lot of payload in the sense of like Satoshi's that I put in the HTLCs, but I can fill up your payment channel. As you know, you can only have 483 HTLCs concurrently in flight, and I make a circular onion to myself, and I just don't reveal the payment hasn't for the next 24 hours, your payment channel is completely locked. And certainly I would say we don't even have any, I'm looking at you, but we can't prevent this in lightning. We can just hope nobody does this because there's an economic cost attached to it. We need to have some capacity or liquidity in order to do this, but you can do it rather cheaply, right? So maybe a market emerges where people say, I don't accept too small HTLCs, right? But that is all stuff we don't know yet, right? And then if you really look at path finding itself, like from all these properties coming, it's basically just a summary, and I'm here routing, it's collaboratively done by the network. And this is to me, if I think about it, really amazing achieved with that people came up with this. I'm not even sure if they were aware of this, how strong this property was when they built this. But it's really this distributed network that solves this complicated path finding problem in a really beautiful manner, whereas in lightning, it's achieved by the sender, or maybe a third party of finding service, right? I mean, might happen. I would argue that this is going to be a business model for reasons we can discuss offline, but we don't know yet. Okay, so seeing the table, you're probably already have a pretty good feeling of why path finding is hard on the lightning network. I just want to elaborate on this a little bit more, more, more more, more, more, more, more, more.

## Key ingredient for routing is to know a path

 So the key ingredient for routing is to know path. And in an ideal world, path finding is really easy. I mean, we create a graph or we know the graph from the cross-substore and the nodes are the lightning network nodes. And the edges are the payment channels like the expected, right? And then the weights might be the routing piece. And there is a label for the edges called the balance because that has to be respected to some degree. And then finding a path is just as simple as calculating the extra algorithm on the network. Every computer science student learns this, I think, every word in the world, I hope so. So you can basically take this information from the cross-subprotocol that you can compute the cheapest path and just create an onion and go out and send it. And then one constraint that's why I call it constraint, extra problem is the labels should be respected, right? There's not enough balance then you cannot do this. And after computing the extra algorithm, either you find a path because the network is fully connected and you can actually have it. Or we know that no path exists with enough balance, right? Because the edge rate is labeled student work out and...

## Realty Check! Weights are dynamic

 all this to them, but the reddit check is a little bit different. So first of all the weights, are they really the routing fees? I would say they change with the payment, the amount and over time, right? Depending on like if I really build the graph as a data structure in my computer, I have this in memory, depending on the payment size, the fees and the weights that I use for the DAX trope program, I actually changing because I have this fee rate which makes it a little bit complicated. And also, people can announce to change their routing fees. Then there is no label for the edges, right? I mean technically yes, when you forward the onion, when you select at the path, the onion might come back, right? You remember you have this telescope in metaphor from Christian of saying, you start setting up all the HTLCs in at some point, there is not enough balance there and everything goes back to yourself. So it's private, it's highly dynamic property. So this is really an issue. So we can't really respect these labels when we are selecting a path, might we can only try it out and probe it, probe it, probe it.

## Realty Check! Topology changes during pathfinding

 And then of course, we don't, so so even after we compute the dixtry algorithm, and we try all the paths and the path didn't work, we don't know that no path with enough balance existed. Because what could have happened is I try a couple of paths, they don't work, I try other paths, and meanwhile the network has changed all the balances in the channels, and one of the first paths might have worked through after all, right? So so we, actually when we don't find a path, we don't know that we can stop the routing, technically, we should try again and again and again, it's a little bit theoretical here. And what we do is we probe for paths until we find one. And I mean currently we have a public, maybe 10,000 notes on the lightning network, I didn't look up the number, but it's it's a very small graph, so we can actually afford to do that. But if we want to use the lightning network, it's a scaling solution for Bitcoin and the lightning network really grows, we run into problems from we probe for paths all the time. and

## Realty Check! Dynamic problem with uncertainty

 So it's a highly dynamic problem with a lot of uncertainty. That is what I want you to remember. And this is really a problem that needs more brain power to be solved. So I talk a little bit about the Gossic protocol because this is really the part of the lighting that could help us to make some routing decisions. I'll try to attract him, I'll try to attract him.

## Purpose of the Gossip Protocol

 make it quick because it's basically just what's written in the bowls. So the purpose of the process protocol obviously routing a source base and nodes need to be aware of the topology of the lighting that work which nodes exist, how can I connect to them and how to open the channel with them. I mean, I need some information in order to actually operate these and then what are the channel policies, right? What are your routing fees? What are the HTNCs you're accepting? Is there many more payment? Is there maximum payment? What can I do with if you have ever wanted to use your channel? And yes, I have to slice them down. And then of course you want to share this information with your peers, right? So because the peer to peer protocol you peer with somebody and then you share the information you know about other channels with others and you need some like mechanisms to do this.

## 4 announcement messages

 So there are four announcement messages on the gossip protocol and there are all lightning messages so they are all encrypted. We are my other noise, XK protocol as we saw before. There is the announcement signature messages. They are needed to negotiate if the channel shall become public or not, right? As we discussed yesterday, both parties have to agree when the channel is open that the channel is supposed to be public. If I don't announce my signature for this channel, do you open a channel with me? You cannot make this channel public. When you kind of announce it, but nobody on the gossip network would forward this channel or accept this because there's my signature missing. So then there is the actual channel announcement. So this really makes the channel public in known to the network. So as soon as you have these signatures exchange, you can actually load an announce the channel and it kind of proves ownership of the channel because you have signatures attached to it. So you cannot just like as the denial of service, take it, writing mechanism, you cannot just go out on the gossip protocol and say, hey, by the way, this is a channel, then your peers would not forward this. You need some proof of ownership that you and your channel partner actually, the people who maintain the channel. And then there's note announcements. So this shares a metadata of the note, for example, it's a computer. And I mean, that's a tricky one. I think tomorrow we're going to have a discussion section about privacy on the lightning and that on the gossip protocol. And therefore, I already want you to take this into consideration, right, because I mean, this is an information that's also easy to double check because you can just like, peer with this note and check if there's really lightning note running on this IP address. And now you have a mechanism to connect Bitcoin addresses to IP addresses. This is my opinion, the huge intrusion into your privacy. And the interesting thing about note announcements on the lightning network, they are only possible at least one channel was announced publicly. This is again, a measure to find an out of service text, because otherwise I could just go out and say, how am I lighting note and a sentence message, like, a million times, and then because the protocol would have to do a lot of work. So notes will only forward these messages if at least one public channel was announced and verified to this channel. As we need signatures, these public channels and only exist as we know with a funding transaction that's part of the announcement message. So you need to block change transaction, right? So this really takes away some spam. And then there are the analytics messages. And what they do is they update the channel policies. So once the channel is announced, we only know there is a channel of certain capacity by all these hard data. But everything that is flexible, like the fees, the amount of HG or T3 accept, or the minimum HG or T3 amount, all of that part is part of the channel update message. Okay, I would skip the details of all these messages looked like because I think you can just read them up in the board. So when you talk to this slide pretty quickly, there's actually no message on the gossip protocol for deleting channels from the network. So the way how you delete notes, not only notes, but channels in particular from your gossip store, is basically look at the funding transaction is sent. And then you know the blockchain tells you this channel doesn't exist anymore. Yeah, well, we don't have to fly signal yet. But once we have to fly signal, we need to think about these things probably. And then of course, you can also thinking about privacy with gossip and stuff that's related. You can, for example, see the channel lifetime on the blockchain. Maybe now you're able to note opens other channels to connect channels or connect addresses again, right? Maybe somebody was using the same wallet to run several lightning nodes, or you can maybe not lightning nodes. So we have stuff can happen. You can actually register at my arously.

## Querying the gossip protocol for information

 And then there's another part of gossip messages that exist and these are the various for the gossip protocol. One thing was just the announcement and forwarding information, but loads can reach with old gossip messages from their peers. Question to you, why would this be useful? Why do we need this? Yeah, for example, if the load goes offline, it misses some stuff, right? So it wants to like, at a recent few or another reason, even more basic reason. See, other reason why we need it? What's strapping, right? If the load comes online for the first time, the load wants to make a payment, and it's supposed to be a space routing. It needs to know what the network looks like. So it needs some way of asking the peers of like, hey, what is the network actually looking like? So yeah, so there's queries basically for short channel IDs and reply short channel IDs and messages and what they do is basically, you ask for channel announcement and channel update messages for specific channel. Of course, this is not really of use yet if you don't know the short channel IDs. And that's why I think we have these queries where you have the channel range and reply channel range messages, right? So one is ask for channels in a certain range. And the range is the block height. So you say, come block 500,000 to block 600,000, please give me all the short channel IDs that you know and then come reply messages that basically tell you these are the short channel IDs. And then you can do the other query and ask for channel announcement and channel update messages, right? So you can pull these information from your peers. And then there is the gossip time stem filter. So now you can only have channel updates that have a certain time stem. So you don't want to have all the old channel updates, right? You only want those that are like most relevant. All right.

## Summary of topology information for pathfinding

 So what I do from all these messages, I have a quick summary of information that can be used for outing and path finding. So there's basically the CLTV expiry data, which basically says if you want to route over me, this is how many blocks the HGLC's I want to lock in order to make sure everything works. You have the minimum maximum HGLC amounts that you are accepting, a short channel ID, of course you need this information because on the audience need to put in with short channel you're using and then there is the FU rate when the base FU, right? Remember every time you route through node, you have a certain amount of FU that is fixed that they want to be paid in the FU rate, it's basically looking at how much money are we're forwarding and then the fraction of that is also put into this. And yes, I also included the channel flags, which are a direction and availability of the channels, so there are some flags in the message which is where you can like the internal of your node basically they can announcement of the channel update and now we're offline. Well, I'm not used as channel anymore, I mean it's also takes some time on the information is spread, but it's a useful information to take this away. And then of course for example flags, for example there's this option channel, HGLC Max, which says how many HGLC's do I accept on this channel, something like this, right? If there's a channel that only accepts 20 concurrent HGLC's, you might not want to use this for routing. So yeah, this is all the information that we have and what I would argue is basically taking into consideration the first part of this talk, this is not really a lot of information. I mean some information and of course you can like maybe get some other information from elsewhere, but it's not a whole lot of helping me as a source to make qualified routing decisions. All right, so after doing this, I actually had an X-Cose on the Ghosted Protocol where we had a note to much about it's go on with it being productive and we'd still have another

## Strategies for path finding

 So what I strategy is for path finding that the current you know will. Once friendship you are already mentioning for probably the cheapest path, or cheapest path is like maybe the first one doesn't work so we do the second one. Then Alex talked a little bit about atomic multipathalalting. Right so his good payments into smaller pieces and maybe that helps you to find some whole way through this network instead of making one arch payment. I came up with this concept of just in time routing and I will talk a little bit about it because the MPB already saw yesterday. It's my idea of bringing the best effort concept back to lightning but keeping privacy properties because we already have seen trampoline payments and when I created the slides I thought I hope this talk earlier and said I hope to learn something that I already did yesterday and came back to me. Which also tries to bring this best effort method back to lightning but it comes with a privacy issue and I should be honest about it when I drew it in the way of how I would want to do it also comes with lower privacy with more success rate. I think there is this general concept like the best private wire I've seen is already from IP networks easier the path funding gets. And last fantasy that we're not a leverage or not only but I think it's a very viable strategy so you can use cruise knowledge. I don't think Alex already talked about it. You can look at the previous routing attempts who were good nodes before which kind of the stuff worked or you can use up time of nodes. Like information you have from other sources you can use this.

## Considerations when probing for paths

 So I want to mention some considerations for each of these methods and for digital things, again, I will do two or three slides to explain how it works. So what is the considerations for probing paths? I mean, one has to compute the shortest path from destination to the sender. Is it actually clear to everybody why I'm not computing the shortest path for me when I want to do so I'm the source, it's source based routing. And why do I have to compute the shortest path starting from the recipient to me and not from me to the recipient? Yeah, exactly. And the fees like if the fees were fixed, it wouldn't matter. But since we have the fee rate, the later hops already like change the amount that is being forward and they change the fees of the earlier hops basically. Because the fee rate says that many seotrocious depending on how much you're going to forward. And so later fees actually have an impact on the routing. So yeah, I wrote this down here. We need an adapter to dynamic version of the dixtral algorithm. So dynamic as the actual weights change with every hop in the amount of the only changes, so you don't have a fixed graph like whatever you make a step depending on the few weights, stuff changes. And the adapter we actually need to prop K-parts, the first name is one part failed. And if you look this up for K-shirt path routing in Wikipedia, you come up that there is Yens algorithm for example and also some others. And the runtime is okay times n times n times n plus some lock in this. But as if you look at the main component, you have the number of nodes, the number of edges and then times K like every product you do this to have this like loads times edges. Yeah, so that actually help you if all the K-shirt is passed goes through one channel and that's the channel that is dying, you can throw away your entire result. Yeah, so yes, I agree. But at some point in time, there will be paths that are more expensive going through another channel. So of course you can use a different algorithm, adapter version with the more information you get back. So yes, I'm not saying we should use this algorithm. But I was saying if you broke for paths and the only thing you do is you start with a shortest path because you want to save on fees, right? I mean the notion of short here is also tricky. I mean you could also say not in a short and order of hopes that you're doing and then you just breath from search. I'm just wondering if computing K shortest paths is not more expensive than you're just doing it, doing the single shortest one adaptively over and over again. Probably it's better to do the single shortest paths adaptively but still it's an expensive algorithm, right? So I agree that the K shortest path is a really good solution if you have some really expensive piece of service that you're talking to and the latency to talk to it is probably expensive as well. But if it's located right next to your actual note that might be cheaper to do the adaptively. Yep, why do we? But in any case I mean we just cast this yesterday already. If you're running lightning on your mobile and your mobile is supposed to do this for a graph, I mean let's let's plug in some numbers, right? Let's say I don't know. Say Camille your notes and reasonable amount of channels that are coming with them and you multiply these two numbers you get at a lot of computational steps that's getting ugly pretty quickly. So it's pretty inefficient and hard to compute on a large scale. On lightning network in particular on mobile devices maybe one of the reasons why I'm suggesting that path finding might be a service that is being outsourced where you just ask a path finding service to give you a path or you could outsource this by having the network finding a path for you. Which would mitigate the trust issue here a little bit or this is your privacy to some degree because if you ask a third party service the third party service at least knows that you want to pay a certain person on the network. So if all notes behave well a single path should be quick maybe one second to do it independently of the network size, right? I mean this is a very nice and then we're finding and routing. The problem is if notes miss behave, probing can take a long time. Because as we learned yesterday we should not try to pay a second time with payment doesn't work, right? And while probing a path we could actually end up in this scenario where something maybe hit the chain or maybe there's just some time out we don't know what the note is doing. HGLC's are being set up but you don't get anything back you don't know what's going to happen. So you're going to wait like really really long for one probing attempt, right? It's not a computation, we have a problem on your side so um

## Considerations with AMP

 Considerations with M. It's a little bit like trash talking this right now. It's not in the sense of like I'm not a fan of M. But I want to point out the problems. So there are advantages I refer to LX for them and you already mentioned some of them. But the idea is we know it's basically a known fact that larger payments have a higher likelihood to pay. I mean you can simulate this very easily you can try this out. You can use your own data. You can do whatever you want but you will mean it's basically common sense right? Some point in time, some channels just are less likely to have enough balance for you. So what you could do is you can split larger payments into several smaller payments and send them along a very smooth. So what are the disadvantages of this strategy in my opinion? Well one thing is the routing time agrees to increase the stress significantly because an atomic multi-part routing still we need to probe every of these smaller paths. And we already saw that probing might take a really long time. So now let's... No, no, no, no, it's that. It's the maximum time for each part. Because the pre-image by the end of the day is only going to be revealed when enough incoming capacity over all HTLCs is there. So now comes the problem. If I'm probing one part and this part is just misbehaving, I don't know what to do. I'm just waiting. And now it's getting even more messed up because different parts that I'm probing might have different CRTV expiry times. So stuff gets really ugly. I should probably mention that what you're referring to probing is what I call a payment attempt and I use probing differently. So finding your route and not probably wrong. But finding the route is just taking that more work but actually trying it could this is your worst case. Now so the thing is an atomic multi-part routing, I can concurrently actually try those routes. Right. So so this is not the issue here. The issue really is that if one of these routes takes a really long time, all the other routes have to basically wait because they don't settle independent with your feature other. And say so, larger payments from a likely fill and using more notes, it's more likely to cause a problem. True. Yeah, yeah, this would also be a rule of thumb, right? And then an important thing is we're decreasing the amount to pay, but we decrease the amount to pay, but we increase the amount of notes that we evolve and yeah, this is bad. As we just discussed probing is still necessary for every path, then also the base fee is paid several times, right? So I am just also more expensive. Side note, due to lunch discussion with me about the fee model in lightning, because I would argue that we should actually get rid of the fee rate because a lot of the data signs, part makes a lot more sense when we actually have base fees and smaller fees, as small payments. But that's a different discussion I don't want to fault here, but here James. It's no big deal. That's a really cool thing about the design of lightning. Remember, yesterday we already had this like, I was surprised that this was a frequent misconception. I think it was not really in the room, but we discussed it. If on or out, the channel closes, the other HGLCs are still settled off-chain. So also an M, if some of these things breaks, I mean it closes, it has a long time lock. Right? So if the other stuff like works out and we release the pre image, yeah, right? But again, I mean these paths have to wait anyway all the time, right? So so what M will or might do or could do, right? I mean this is all speculation anyway, because we haven't built this and we don't know this. But what I'm saying is the danger of empis, the payments now have a really good likelihood of always take 24 hours or whatever, it's not lightning fast anymore, because it's sufficient that one single path is taking your time. Yeah, so you, well, I mean one thing you can do in lightning already is you can overpay it a little bit. Already to to office paid some stuff, right? So you could say, well, I'm willing to overpay a little bit. I have fees anyway. So I make a couple paths more maybe a cent or something, right? And in this case, if one path fails, you'll see if you at some point times as well, I have enough parent now I release the pre image, right? And with the rest whatever happens. So thank you all for the question. Yeah. So I mean for all of you, yeah. Payment has currently in the suggestions, yes, but I think when we go with payment decorrelation and stuff, we could also like come up with ideas. But as I said before, remember this picture, right? It's very often we can be very creative here. But so if you currently think, oh, they might be a way of making different pre images, right? I mean you can simulate m already. Can already say, hey, I want to pay a merchant and I really trust that merchant, right? I don't trust the payment provider, but I trust that merchant. Because the merchant sits in Australia, because the merchant sits in Australia. But what I'm saying is of course you could simulate m already and tell the merchant, hey, please give me one euro in one dollar invoices. Did you pay one invoice after a time? Right? And if one of those got stuck, you'd be like, hey, I can't go on. So now that right here, you could do that technically and then you have different pre images. So so there's many m proposals floating around as you know, right? And I think one of the reasons by many proposals are floating around is because nobody came up and said, hey, by the way, this is a really good solution for path finding and everybody else said, oh, yeah, we agree. It's very obvious that this is a good solution. Let's go for it because we currently figuring this out. And as I said before, that's a great opportunity for you having learned about all this stuff because you could actually work on these issues. On the next slide, I will show a small table to argue that it's not even clear if the likelihood for successful payment is higher when use split those payments. So keep this for a second. Another disadvantage of m is you have more HTNCs in flight. I think we discussed this yesterday already in the room a little bit. When you make more payments and those payments tend to be longer because you have to wait for the longerist path. More HTNCs and more payment channels are in use. Which could result in several things. One thing is, I think I have this as points here. Yes, statistically, we waste more block space if channels break because statistically speaking the chances higher that on this channels, they are currently more HTNCs. These HTNCs usually are also smaller. The fees might eat up a lot of stuff. And the channels might become overloaded. So remember, a channel can only have 483 HTNCs. That's assume we make really, really, really, really small payments. Then we're going to like eat up a lot of HTNCs. So we have to think about it. We want to do that. I end for improvements for m. I can't leave a refer to the talk of Alex that he already gave and his questions that we brought online. So again, I don't want to say m is a bad idea, but it has some problems and we should be aware of these problems. I promise you to talk about the question if actually m has a higher chance of routing a payment. And I have to say these are really completely arbitrary, not cherry-picked probabilities that I used in this one. So what I did as I said, well, let's assume the probability of successful large payment is only 20%. And the probability of a small payment is 80%. And I don't even know what small and large actually means. But I thought 8020 rule is always a good thing to start with. And again, it's completely arbitrary. So the m, success probability is you take the probability of a small payment and this has to happen for every small payment. So you have to like basically compute this exponential. And you ask the question, is this really bigger than the probability of a large payment to fail? And obviously better you do a simulation, if you do whatever. I mean, this is just a really rough thing. Sorry for the transition here. You come up with this table. So here, this probability is always fixed. And this is the number of paths that I would use in atomic multi-path routing. And obviously, if I only do one path, it's the same, right? For two paths, I didn't go directly to 80% because it's still fairly large payment. So I went to 0.4.6 and from there, on I said, it's always 0.8. Probably it's, again, I mean, it's just rough numbers. But what you can see is there's only a small window in which you actually get a higher probability with atomic multi-path routing in comparison to just use the standard large payment. And in this small window, don't take this series now because all the numbers are completely arbitrary choosing, right? But if you think about it, it's not even clear. There's counter arguments to what I'm currently presenting, obviously, right? Because this formula is not really true. I just want to have failed, but you just want another one. It's a bit multi-path routing. So eventually you might get it because you already have like a large fraction, but there might be really constraints on the global view of the network that really in the U to find the path, even with atomic multi-path routing. And it's not even clear when this fails.

## Short Intro to Justin Time Routing

 So, good writing. Good writing is just in time routing. It's the following idea. Let's say S1s to make a payment of 90s to 12G to R. And this is how net recovery looks like, right? So, S and B have a channel of capacity of 110 to 10 Satoshis. We'll never let small and lightning, but S has the balance of 100 to 12G. And B has a channel with R, which has a capacity of 200, but G only has 80 Satoshis on this channel. And then B also has a channel with T also, the capacity is 200. The balance for B is 80. And then here's another channel, which is evenly balanced. Everybody has 100 Satoshis. So, what you can already see is, when you probe this network, you don't find it a path. Because, here you can't forward 90 and here you can't forward 90. And then very obviously you can't do it with M. You can just do a certain split in M, and then you find the solution. What I'm trying to do in just a time routing is this picture. So, when the onion, so S selects this path over B to R. That's the path that S is really crowding and doing. When B receives this onion, B says, I can forward this onion. In a regular payment, B would now send back an arrow and say, I can't forward this onion. All the HTLs go all the way back to S and nothing happens. But B could now say, well, we do something, and I think I wrote this down here. Sorry. What B could do is, B could use one of the coolest tricks that we use in lightning. What is the coolest trick that we use in lightning in general? Mm-hmm. Yeah, every balancing is the idea, but what is the concept, what B does now? What is happening to yourself? No, okay, I just give you the answer. B is B, B is deferring the routing process to the future. Right? And remember, lightning, with deferring publishing Bitcoin transaction to the future was a good concept. Right? So, so we're doing the same here. B says, instead of sending back an arrow, I do what you say, you're rebaddance. Right? So now B does circular onion. Sending 50 Satoshi on this channel, only having 30 now. This one also moves some capacity on the channel. Now there's 130 Satoshi on the channel. And what you can see, the payment will flow. Great. So what people want to be doing is the same thing that you now has to do. Well, that can't happen because the onion is already constructed. Right? That can't happen. Just contain some redundant fees, then. So that others can do the zone. I mean, let's set the question. Right? I have different suggestions to mitigate this problem. My suggestion is that I don't accept it. Yeah. Okay. No, I can't just in time because you get your liquidity that you need just in time. So your supply chain concept. What happens if I cancel the receiving of the payment? If you can't solve it, if I cancel my receiving, I don't accept it. Who are you in this graph now? If I'm getting the payment and you do the just in time routing. Yeah. But I just, when the payment comes to me, I just cancel. I rejected. Well, that's no big problem because if you read of the mailing list, the first suggestion that you can do the rebalancing with the same payment. In that case, the rebalancing only takes place. If you accept the payments, so you only pay fees for the rebalancing of the payment. And in that case, you still don't have enough capacity to go through the R. Because you already are here, right? I mean, in that particular problem. Because if you bind the rebalancing to the same preimage, then the HLCs will not get resolved and you can create a new HLC for 90. No, but here, since you have two HCCs in two directions, they could have a protocol of mitigating this. You could. I'm not saying we should do it. I'm saying you could. Because I even have a different suggestion for this. So, in general, my suggestion is the peers might want to submit the fees on the rebalancing operation. Okay. So, in general, if you look at graph theory, there is a certain amount of networks you should always look at when you look at a graph. So, there's one thing that is called your ego network. That is if your B, your ego network consists of ST and R. Everybody who is around you. And, I mean, that's the network that you usually know in lightening very well. Because you have your note and you know what's with your channels and your peers. But what I would suggest is to look at your friend of a friend network. So, if I am S, my friend of a friend network actually goes all the way to R because all the friends of my friends are in there. And if you do the math, you will realize that all circles of length five are in your friend of a friend network. So, what if, and that's a question, what if we would argue and say, you know what? In your friend of a friend network, we introduce another gossip query or another query of saying, Hey, to all my peers give me your channel balances of all your channels right now. And I have a very local view where I actually know the exact topology and I can suggest a rerouting the rebalancing route. And I could even do it public, right? I could extend the bold protocol and everybody on this route would say, hey, actually, each of one of us is better to now shift these funds. So, now you can do the rebalancing for three. You could, right? I'm not saying we should do it in this way, but I mean, this is one way of achieving this. And if you compared with the privacy model of a trampoline, it might actually be a better privacy model. And you don't have to do it as drastic as I'm suggesting this right now. I mean, you could also have a query of saying, hey, tell me channels on which you want to have inbound capacity or tell me channels on which you want to have outbound capacity. I just continue. I just continue.

## Considerations with JIT

 So some considerations with it, I think the idea got clear. So the disadvantage is you need additional probing for the rebalance operation. It may be costly for routing nodes, right, especially when you do it on the current system, because you'll just have to pay fees, and maybe even for the rebalancing use a different preamage, because currently that's easier. The CRTV data is currently might not be sufficient to support an additional routing operation, because they're very tight on time, and you don't find a route that actually completely works on smaller CRTV data. And it also increases the time because there is a time needed for rebalancing. Again, as I mentioned, one way of improving this is of creating this friend of a friend overlay network, and maybe extend the gossip protocol here to exchange a little bit more information. Similarly, in this like BGB setting, we could use some aggregated information about channels to do this. And we could use cost-free sort of the roads in lightning. Especially if they are not encrypted, you know that you can't use them for like the nanoservice text or something, because you know who is involved. Alright, um, right, um, right, um, right, um, right, um, right, um, right, um, right, um,

## (Multihop) Trampoline payments

 multi-up trampoline payments. So the high level idea I think we already saw it to get the best effort component in you define a rough route, if you do multi-trampulines where you say hey it should go through these trampolines and then let the nodes on the route figure out how to do the actual paths between the trampolines. So again you shift this path finding problem to those people who are along your route. So I think yesterday the idea was coming up but not very clear that it might make sense on lightning to to extend the gossip protocol that the trampoline nodes have like their own network of saying I'm pretty confident that I'm able to like forward to Christian even though we're not direct peers or something like this. So then on this like trampoline network I could make a route where somebody in the end was could say hey use this trampoline as an exit trampoline kind of this thing or in this way. This advantage is that it needs a protocol change currently we need these mixed onion formats which is always a little bit and I think it's coming but we need it. So yeah the onion format needs to adapt it a click of trampoline that is in my opinion a more severe problem might emerge and build a cartel especially if we even enforce something like this on the protocol level. So so they could be I think the question was already coming from the room a centralization or a hub in spoke to apology might emerge and the privacy model decreases a lot because the trampoline really knows I'm doing a payment to somebody else. I'd also somebody's doing a payment to somebody else where's a digital thing you don't have this problem. Right the the person initiating the rebalancing just knows like before from where to where on the local view but not on the global view. And I think yesterday we kind of figured out that it wouldn't work for all at least right now helpful to maintain this payment protocols. So for improvements I refer to talk to Christian probably also to Cameroom.

## General thoughts on pathfinding on Lightning

 Okay, so just to sum up some general thoughts on path finding, I think we should acknowledge how I already did in the other talk that path finding is an open and difficult problem for the lightning network. We should not ignore this and I personally think we should not wait to tackle this problem. But I mean you could argue currently the lightning network is small and our current mechanism works, but if we need to via protocol changes for some of these ideas or even other ideas, then of course it might be too late once the lightning network is already widely spread, so I think this is really problem we should quickly work on various proposals and ideas. Exists some of them require protocol changes and different strategies could be combined. I want to emphasize this, right? You could combine trampoline payments with jet routing, with AMP. You can combine AMP with jet. You can do all of these, right? It's not like one algorithm wins maybe, maybe it does at the end. And there seems to be a trade of between these strategies, right? Some have like more privacy of individual nodes or the ability of the network to solve the path finding problem, like really like where do we want to stand on this? And yeah, I say lightning might want to copy some ideas from the autonomous system space. In particular, I think it's really useful if we have this hierarchical address space or its Christian suggested to have like a core open routing protocol on the base that always works and then create an encrypted layer on top of this, like because this will just increase the success rate and not everybody has this with the privacy anyway. My personal opinion is that path finding, as I mentioned before, will emerge as a business model and opportunity, because if we keep it with this current set up, then people with third party services will definitely win because once you offer that service, you easily might have more information than other nodes on the network and then you can offer better paths. Why do you have more information? Well, I think it's similar to the Google setting. But everybody can now set out and write a web crawler and have like a view of the web graph, but Google, oh sorry, Google has all the lock files and the lock files are in crucial part piece of information that help Google to make better search search search search search search

## Path finding has many open challenges!

 So I conclude my talk by saying, how finding has many channels, a channel, tell them just so we think about them, join us and take this problem serious. When I figure out which channels, weactor maturity technologies call drug dealership and make a rich television community in a shared-room, link to the big.


