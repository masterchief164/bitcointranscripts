---
title: Path Finding in the Lightning Network with Ren√© Pickhardt
transcript_by: masterchief164 via TBTBTC v1.0.0
media: https://www.youtube.com/watch?v=NT_dMqB1xuA
date: 2021-08-19

---

 And now today I'm going to talk a little bit about part finding on the lighting network and some part of it will be about the gossip protocol, which is like a little bit of a review of what the gossip messages are going to look like. So it's a little bit basic again, but other than that, I've been told that you seek more for like opinionated talks and recent ideas instead of like how the bolts work because you already know all of that, so I'm trying to go a little bit more in this direction. Yet I'm still an educator, so we're going to do a little bit of education. So the outline is I will start with the quick recap of the 2018 lighting residency, as I was a resident at that time, so I thought I shared a little bit of my experience with you. Then I'm going to compare IP routing with routing on the lightning network. And Christian already mentioned a couple of things on that. Then I will go through the motivation of why our finding is actually a difficult problem on the lighting network. And then I go to talk about actual path finding strategies. And a little bit more gossip than that about the outline. Actually, I haven't the outline, but I was shifting topics. So yeah, this was the picture of last year's lighting residency, so the quick recap goes like this, it started with Christian explaining me that routing is a hard problem. And then there was Elaine, who actually told me that routing impact is always fails. And then we had Christian again who explained me that routing can be difficult and to rise on channels and capacity and PSBing online. And then there was Jake Malers, who if you read it correctly, was talking about autopilots and the channels won't be relevant, so he touched this topic of this is difficult. And this is what I got out of the residency that routing has some back problem. As we discussed yesterday, this is plain wrong. Routing has been solved on the lighting network. It's actually path finding that it's the hard problem. So I want to be a little bit more precise on the terminology that I'm trying to use in this talk. So the good thing is I want you. I want you because these are open problems and you can make a huge difference on them. I would currently say that we don't have a working solution for path finding on the lighting network. There's many proposals out. We already seen some yesterday. And I will hold a little bit through them again today. So especially for these people staying in the summer and wanting to work on lighting, I think this is a great opportunity because there is also, yeah, really the chance to make a huge difference. So I want to motivate you to think about these problems. All right. Right. This is not working. I just used this one. So as I promised before, like really going into path finding, let's compare IP routing with onion routing in order to understand this. So let's do a quick recap of how IP routing works. I think most people are familiar with this. The load processes the IP header of the IP package that it receives, then it extracts the sender and the recipient of this package. Actually, it would not necessarily need the sender for forwarding it only for response and IP. And then it dissects the IP address of the recipient into the network part. And the network part, you know, it's usually the first upload digits or bits. And it's a hierarchical address scheme, right, which the network uses for making routing decisions. And then there is the host part of it. And the router looks up the network part in its routing table and the network is known that it sends the link to the package to the next link by the link layer protocols of example, if a net or DSL or whatever link layer protocol, they're implemented. And otherwise it will send it to its default route, which is something like, hey, you probably know better how to handle this. This is pretty much how IP routing works. And the routing tables themselves there dynamically updates it. For example, via the board, a gateway protocol, I think there's several variations of those. But there is basically some communication among internet hosts and internet routers that basically talk to each other all the time and share information about the topology of the network of where networks are located. And then they can make decisions of where to forward this package. And the concept, how I always call it, is called best effort routing. This is always used as the word distance vector routing. I think that's in computer science terms, the more precise term, but as you can see from I showed I know math, but it's so these forgive me. And I would say this is an amazingly strong concept. And think about it. The internet is just running all the time. If you talk to the people who came up with PCPIP, I think maybe they were just humble. But what they usually say is we didn't expect this to scale that much. They were doing just a research project for university. And then it took often people who are just implementing and building on top of it. And I mean basically, yes, we had this address based in the lemma, but some degree it's scaled to infinity. It's one of the strongest tables, computer systems that we currently have. And I just want to make it one last time like explicit of how it really works. Like there is the address of the IP package that states, I want to go to chain code labs. And what the router does is it says, oh yeah, that's in New York because this is what it reads from the host part. And then it says, I sent you along this road because this gets you closer to New York, ask again later. And then you go to the next cross way or next router, then you can repeat the process basis. This is how information is being sent on IP. And this is actually path finding, right? Network finds a path. So I want to compare IP routing with onion routing, or at least with onion routing, how we use it in the lighting at work. So the first type, as we already mentioned, an IP routing, we have this method of called best effort routing because every router basically has its best effort to say the best thing I can do is send you along this road. Where in onion routing, as we discussed several times, we have the source based routing, the sender has to make all the decisions about what path to use. And then the data format is very different because in IP, we have open headers. Everybody along the path can read the header information, whereas enlightening we basically have encrypted headers. There's only a small part of the header that gives a hint of what you should do at your hope, but the rest of the entire information is encrypted and the hidden away from you. The sender and the recipient are known to the routing node, so they can use this information to help with routing, to make decisions, whereas in onion routing, I think it was for Greece yesterday, who is really, I think some people already mentioned it to me and for me it was also eye-opening of saying, it's really funny that routing nodes don't actually need the process protocol and the gossip store to some degree because they are just going to forward the packet anyway to their peers. They don't even have to be aware of the geology of the network. And then in IP routing, we have an address based that is logical and hierarchical overlay network. And to some degree, I would argue it reflects some geographical properties, right? I mean, the IP networks that you usually have are usually located in some direction. It doesn't have to be like this, but usually when you make requests to your router, your graphic in your country or in your region, you don't necessarily go over China unless you do something like for arsenal. Whereas in the lightning network, it's really a fully decentralized peer-to-peer network. The addresses, you know, are just public ease and curve points, right? They don't give you any information of that and we don't have this address based in that sense. Then when you talk about the edge rates of the network, in IP, I would argue that they're mostly static, right? You have the bandwidth of the links that are basically the information that you need for routing, a package arrives and then you say, oh, I can actually forward it on this link or this is what you could use to make routing decisions. If you look at the routing table protocols, they might use this and say, hey, this is less hoops, but the hoops are really slow, so I'd rather take a longer route where I can actually really push through traffic. Whereas in lightning, it gets really strange with the edge rates. It's first of all, not even clear what to put on the edge rate, but I would argue it's highly dynamic. The piece can change or another edge rate that you should use for routing is actually the balance. How much money is in this channel and not in the channel, but on your side of the channel, because that's the only, that's a necessary condition to be able to forward a package, right? And this thing is changing all the time with every routing process, this thing gets updated. So if you think about the topology and information propagation, the network in IP can react to changes of the topology pretty well. So we have this border gate where protocol and if some routes are fails or we just switch some cables, routing tables are being updated. It takes some time, but since the network is full, it's all on, we might find some other routes, it's still working pretty well. If we look again at this like fully decentralized peer-to-peer network, we have a gossip protocol, which is rather slow. It's noisy to propagate all relevant information. For example, if you think about the balance, let's consider we ignore privacy for a moment and we just want to propagate the balance of all the channels at all the time. This would be a mess because it's changing with every payment process. So it technically is not probably not even possible to achieve this, right? But then again, we want to have privacy, so we might not even want to share this information. So this entire topology and information about how the network looks like in lightning, we don't have this. Then if you think about the Nile of Service Attacks, in TCPIP, you can do this moving. I mean, I can just send out an IP package and say it comes from a certain sender and then the nodes will reply to this. Since everything is open, since we have open headers, the ISPs can actually monitor us some behavior like this and can interfere with this and can mitigate these attacks. Whereas in lightning, everybody or anyone can just send and delay onions. This is pretty much impossible for us to detect or to mitigate. So if you are running a lightning node and I want to be nasty, I just want to send some onions away. Don't put a lot of payload in the sense of like the torches that I put in the HTLCs. But I can fill up your payment channel as you know, you can only have 483 HTLCs concurrently and flight and I make a circular onion to myself and I just don't reveal the payment action for the next 24 hours, your payment channel is completely locked. Currently, I would say we don't even have any, I'm looking at you but we can't prevent this in lightning. We can just hope nobody does this because there's an economic cost attached to it. We need to have some capacity and liquidity in order to do this, but you can do it rather cheaply. So maybe a market emerges where people say I don't accept too small HTLCs. But that is all stuff we don't know yet. And then if you really look at path finding itself, like from all these properties coming, it's basically just a summary. And I'm here routing, it's collaboratively done by the network. And this is to me, if I think about it really amazing achieved with that people came up with this, I'm not even sure if they were aware of this, how strong this property was when they built this. But it's really this distributed network that solves this complicated path finding problem. And really beautiful manner, whereas in lightning, it's achieved by the sender or maybe a third party of finding service. I mean, might happen. I would argue that this is going to be a business model for reasons we can discuss offline, but we don't know yet. Okay. So seeing the table, you probably already have a pretty good feeling of why path finding is hard on the lightning network, I just want to elaborate on this a little bit more. So the key ingredient for routing is to know path. And in an ideal world, path finding is really easy. I mean, we create a graph or we know the graph from the cross-supps store and the nodes are lightning network nodes. And the edges are the payment channels, like the expectors, right? And then the weights might be the routing piece. And there is a label for the edges called the balance, because that has to be respected to some degree. And then finding a path is just as simple as calculating the extra number of modern networks. Every computer science student learns this, I think, every word in the world, I hope so. So you can basically take this information from the cross-supps protocol that you can compute the cheapest path and just raise an onion and grow old and send it. And then one constraint, that's why I call it constraint, the extra problem is the labels should be respected, right? If there's not enough balance, then you cannot do this. And after computing the extra algorithm, either you find a path because the network is fully connected and you can actually have it. Or we know that no path exists within our balance, right? Because the edge rate is labeled, it didn't work out. And yet then you know this tool. But the reddit check is a little bit different. So first of all, the weights, are they really the routing piece? I would say, they change with the payment, the amount, and over time, right? Depending on, like if I really built the graph as a data structure in my computer, I have this in memory, depending on the payment size, the piece and the weights that I use for the DAX trope program, I actually changing because I have this f-rate, which makes it a little bit complicated. And also, people can announce to change their routing fees. Then there is no label for the edges, right? Technically, yes, when you forward the onion, when you select it apart, the onion might come back, right? You remember you have this telescope in metaphor from Christian of saying, you start setting up all the HTTles and at some point there is not enough balance there and everything goes back to yourself. So it's private, it's highly dynamic property. So this is really an issue. So we can't really respect these labels when we are selecting apart, but we can only try it out and probe it. And then of course, we don't, so so even after we compute the DAX trope algorithm, we try all the parts and the path didn't work, we don't know that no path with enough balance existed. Because what could have happened is, I try a couple of paths, they don't work, I try other paths. And meanwhile, the network has changed all the balances in the channels and one of the first paths might have worked through after all, right? So so we actually, when we don't find a path, we don't know that we can stop the routing, technically, we should try again and again and again. It's a little bit theoretical. What we do is we probe for paths until we find one. And I mean, currently we have a public, maybe 10,000 nodes on the lighting network, I didn't look up the number. But it's a very small graph, so we can actually afford to do that. But if we want to use the lighting network as a scaling solution for Bitcoin and the lighting network really grows, we run into problems when we probe the paths all the time. And yeah, I have a set of speed. So it's a highly dynamic problem with a lot of uncertainty. I did this, what I want you to remember. And this is really a problem that needs small brain poetry solved. So I talk a little bit about the gossip protocol because this is really the part of the lighting network that helps us to make some routing decisions. I try to make it quick because it's basically just what's written in the bowls. So the purpose of the gossip protocol obviously routing a source base and it notes it to be aware of the topology of the lighting network, which notes exist, how can I connect to them and how to open the channel with them. And I need some information in order to actually operate these. And then what are the channel policies, right? What are your routing fees, what are the HTNCs you're accepting, is there a minimum payment, is there a maximum payment, what can I do with you if I want to use your channel? And yes. I have to try some of the slides now. And then of course you want to share this information with your peers, right? So because the peer-to-peer protocol you peer with somebody and then you share the information you know about other channels with others and some like neck and feet to do this. So there are four announcement messages on the gossip protocol and they're all lighting messages so you're all encrypted. We are my other noise XK protocol as we saw before. There's the announcement signature messages. They are needed to negotiate if the channel channel can't public on that, right? It's we discussed yesterday, both parties have to agree when the channel is open that the channel is supposed to be public. If I don't announce my signature for this channel, do you open a channel with me you cannot make this channel public? When you kind of announce it but nobody on the gossip network would forward this channel or accept this because there's my signature missing. So then there is the actual channel announcement. So this really makes the channel public need known to the network. So as soon as you have these signatures exchanged you can actually vote and announce the channel and it kind of like proves ownership of the channel because you have signatures attached to it. So you cannot just like as the denial of service, take it, writing mechanism, you cannot just go out on the gossip protocol and say hey, by the way, this is a channel and your peers would not forward this. You need some proof of ownership that you and your channel partner actually, the people who have maintained the channel. And then there's not announcements. So this shares some metadata of the node for example, it's a computer. And I mean that's a tricky one. I think tomorrow we're going to have this question section about privacy on the lightning that on the gossip protocol. And therefore I already want you to take this into consideration, right? Because I mean this is an information that's also easy to double check because you can just like peer with this node and check if there's really lightning node running on this IP address. Now you have the mechanism to connect with coin addresses to IP addresses. This is a micro million huge intrusion into your privacy. And the interesting thing about node announcements on the lightning network, they are only possible at least one channel was announced publicly. This is again a measure to find an out of service text because otherwise I could just go out and say, how am I lighting node and a sentence message like million times and then it goes to protocol which has been a lot of work. So nodes will only forward these messages at least one public channel was announced and verified to this channel. As we need signatures, these public channels and only exist as you know with the funding transaction that's part of the announcement message. So we need a block change transaction, right? So this really takes away some spam. And then there are the channel update messages and what they do is they update the channel policies. So once the channel is announced, we only know there is a channel of certain capacity by all these hard data. But everything that is flexible, like the fees, the amount of HG or Cs we accept or the minimum HG or C amount, all of that part is part of the channel update message. Okay, I would skip the details of all these messages looked like because I think you can just read them up in the board. So when you I would talk to this slide pretty quickly, there's actually no message on the gossip protocol for deleting channels from the network. So the way how you delete nodes not only nodes but channels in particular from your gossip store is basically look the funding transaction and then you know the blockchain tells you this channel doesn't exist anymore. Yeah, well, we don't have to fly signal yet. But once we have to fly signal we need to think about these things. And then of course you can also thinking about privacy with gossip and stuff that is related to you can, for example, see the channel lifetime on the blockchain and maybe now you are able to node opens other channels to connect, and nodes are connected to the addresses again, right? Maybe somebody will be using the same wallet to run several lightning nodes, like lightning nodes. So weird stuff can happen, I can have a bunch of IP addresses and yeah. And then there's another out of gossip messages that exist and these are the various for the gossip protocol, right? I mean one thing was just the announcement and forwarding information, but nodes can reach with all gossip messages from their peers. Question to you why what this beautiful, why do we need this? Yeah, for example, node goes offline, it misses some stuff, right? So it wants to like, at a recent few, another reason, even more basic reason, the other reason why we need one strapping, right? One's to make a payment, so what's based routing, it needs to know what the network looks like, so it needs some way of asking the peers of like, hey, what is the network actually looking like? So yeah, so there's queries basically for short channel IDs and reply short channel IDs and messages and what they do is basically, you ask for channel announcement and channel update messages for specific channel. Of course, this is not really of use yet if you don't know the short channel IDs. And that's why I think we have these queries where you have the channel range and reply channel range messages, right? So one is ask for channels in a certain range and the range is the block height, so you say, come block 500,000 to block 600,000 please give me all the short channel IDs that you know and then come reply messages that basically tell you these other short channel IDs and then you can do the other query and ask for channel announcement and channel update messages, right? So you can pull these information from your peers. And then there is the gossip time stamp filter, so now you can only have channel updates that have certain time stamp. So you don't want to have all the old channel updates, right? You only want those that are like most relevant, right? So what I do from all these messages, I have a quick summary of information that can be used for routing and path finding. So there is basically the CLTV expiry data, which basically says if you want to route over me, this is how many blocks the HGLC's I want to lock in order to make sure anything works. You have the minimum maximum HGLC amounts that you are accepting, a short channel ID, of course you need this information because on the audience need to like put in with a short channel you're using and then there is the FU rate when the base FU, right? Remember every time you route through nodes, you have a certain amount of FU that is fixed that they want to be paid and FU rate is basically looking at how much money are we forwarding and then fraction of that is also put into this. And yes, I also included the channel flags, which are a direction and availability of the channels, so there are some flags in the messages where you can like on the return of your node basically they can announcement of the channel update and now we are offline. But on Tuesday's channel anymore means it also takes some time on Tuesday's information is spread, but it's useful information to take this away. And then of course for example flags, for example there is this option channel, HGLC Max, which says how many HGLC's do I accept on this channel, something like this right? If there is a channel that only accepts 20 concurrent HGLC's you might not want to use this for routing. So yeah, this is all the information that we have and what I would argue is basically taking into consideration the first part of this talk, this is not really a lot of information. I mean some information and of course you can like maybe get some other information from elsewhere, but it's not a whole lot of. I'll think me as a source to make qualified routing decisions. So after doing this, the X-Rot X course on the Gostre protocol where we don't know too much about let's go a little bit back to path finding. So what I strategy is for path finding that we currently know well once we have she already mentioned we're probably going to keep this path, keep this path this like maybe the first one doesn't work so we can just say that. Then Alex talked a little bit more to atomic routing path routing. So these good payments into smaller pieces and maybe that helps you to find somehow way through this network instead of making one large payment. I came up with this concept of just in time routing and I will talk a little bit about it because AMP we already saw yesterday. It's my idea of bringing the best effort concept back to lightning but keeping privacy properties. Because we already have seen trampoline payments and when I created the slides I thought I hope this talk earlier and said I hope to learn something and I already did yesterday thank you very much. Which also tries to bring this best effort method back to lightning but it comes with a privacy issue and I should be honest about it when it rooted in the way of how I would want it with also comes with lower privacy with more success rate. I think there is a general concept like for this prime to our. I've seen this already from IP networks easier the path funding gets. And last fantasy that we're not a leverage a lot on but I think it's a very viable strategy so you can use cruise knowledge. I think Alex already talked about it. We've been creating attempts for good nodes before which kind of stuff worked or you can use up-tone of nodes. Like information you have from other sources you can use this. So I want to mention some considerations for each of these methods and for digital lighting again I will do two or three slides to explain how it works. So what is the considerations for probing paths? I mean one has to compute the shortest path from destination to the sender. Is it actually clear to everybody why I'm not computing the shortest path for me when I want to do so. I'm the source it's source based routing and why do I have to compute the shortest path starting from the recipient to me and not from me to the recipient. Yeah exactly. And the fees like if the fees were fixed it didn't matter but since we have the fee rate the later hops already like change the amount that is being forward and they change the fees of the earlier hops basically. How's the few rates says that many Satoshi's depending on how much you're going to forward. And so later fees actually have an impact on the routing. So yeah I wrote this down here. We need an adapter to dynamic version of the DAX driver rhythm. So dynamic as the actual rates change with every hop in the amount of the only changes so I don't have a fixed graph like whatever you make a step depending on the few rates stuff changes and adapted we actually need to prop a path. This is the first name minus one path failed. And if you look this up for a k shortest path routing in Wikipedia you come up that there is Jens Elrido for example and also some others and the runtime is whole k times n times n plus some lock in this. But as if you look at the main component you have the number of nodes the number of edges and then times k like every product you do this to have this like loads times edges. So that actually help you if all the k shortest paths go through one channel and that's the channel that is dying you can throw away your entire result. Yeah so yes I agree but at some point in time there will be paths that are more expensive going through another channel. So of course you can like use a different algorithm or adapt it version with the more information you get back. So yes I'm not saying we should use this algorithm but I was saying if you broke for paths and the only thing you do is you start with a shortest path because you want to save on fees right. I mean the notion of short years also trickier I mean you could also say not in the short in order of hops that you're doing and then you just breath from search. I'm just wondering if computing k shortest paths is not more expensive that you're just doing the single shortest one adaptively over and over again. Probably it's pretty much a two-thousand single shortest paths adaptively but still it's an expensive algorithm right and two times over and over again. So I agree that the shortest path is a really good solution if you have some really expensive piece of service that you're talking to and the latency to talk to it is probably expensive as well but if it's located right next to your actual note that might be cheaper to do the adaptively. Yep. In any case I mean we just cast this yesterday already if you running lightning on your mobile and your mobile is supposed to do this for a graph I mean let's plug in some numbers right. Let's say I don't know. Say Camille your notes and reasonable amount of channels that are coming with them and you multiply these two numbers you get like at a lot of computational steps it's getting ugly pretty quickly. So it's pretty inefficient and hard to compute on a large scale on lightning network in particular mobile devices maybe one of the reasons why I'm suggesting that path finding might be a service that is being outsourced where you just ask a path finding service to give you a path or you could outsource this by having the network finding a path for you which would mitigate the trust issue here a little bit or if this is your privacy to some degree because if you ask a third party service the third party service at least knows that you want to pay a certain person on the network. So if all notes behave well a single path should be quick maybe one second to do it independently of the network size right. I mean this is a very nice and then half-finding and routing. The problem is if notes miss behave proming can take a long time because it's as we learned yesterday we should not try to pay a second time of payment doesn't work right and while probing a path we could actually end up in this scenario where something maybe hit the chain or maybe there's just some time out we don't know what the note is doing. HGLC's are being set up but you don't get anything back you don't know what's going to happen. So you're going to wait like really really long for one probing attempt right. It's not a computationally heavy problem on your side. So considerations with M and it's a little bit like trash talking this right now it's not in the sense of like I'm not a fan of M but I want to like point out the problems right. So there are advantages I refer to LX for them and you already mentioned some of them but the idea is we know it's basically a known fact that larger payments have a higher like you have to pay. I mean you can simulate this very easily you can try this out you can use your own data you can do whatever you want but you will I mean it's basically common sense right. At some point in time some channels just are less likely to have enough balance for you. So what you could do is you can split larger payments into several smaller payments and send them along the varies route. So what are the disadvantages of this strategy in my opinion? Well one thing is the routing time increases drastically because an atomic multi-part routing still we need to probe every of these smaller paths right and we already saw that probing might take a really long time. So now let's no no no no it's that it's the maximum time for each path because the pre-image by the end of the day is only going to be revealed when enough incoming capacity over all HTLCs is there. So now comes the problem if I'm probing one path and this path is just misbehaving I don't know what to do I'm just waiting. Right and now it's getting even more messed up because different paths that I'm probing might have different CRTV expiry times so stuff gets really ugly. I should probably mention that what you're referring to probing is what I call a payment attempt and I use probing differently. The probing is since I'm using so finding your route and I probably won't but finding a route is just 10 times more work but actually trying it could this is your worst case. Now so the thing is an atomic multi-part routing I can concurrently actually try those routes right so so this is not the issue here. The issue really is is that if one of these routes takes a really long time all the other routes have to basically wait because they don't settle independently of each other. And say so larger payments are more likely to fill and using more nodes is more likely to cause a problem. True, yeah yeah this would also be a rule of thumb right and an input we're doing is we're decreasing the amount to pay but we decrease the amount to pay but we're increasing the amount of nodes that we evolve and yeah this is bad. As we just discussed probably still necessary for every path then also the base fee is paid several times right so I am also more expensive. Side note, do you lunch discussion with me about the few model in Lightning? Because I would argue that we should actually get rid of the fee rate because a lot of the data signs part makes a lot more sense when we actually have base fees and smaller fees as small payments but that's a different discussion I don't want to forget but yeah James. I just wonder if I do you have the hand I have to and what general wants of a more price closes. Do you have to do the other? What happens there? It's no big deal. That's a really cool thing about the design of Lightning. Remember yesterday we already had this like I was surprised that this was a frequent misconception and I think it was not really in the room but we discussed it. If on or out the channel closes the other HGNCs are still settled of chain right so also if some of these things breaks I mean it closes it has a long time lock. So if the other stuff like works out and we release the pre image yeah but again I mean these paths have to wait anyway all the time right so so what what M where might do or could do right I mean this is all speculation anyway because we haven't built this and we don't know this but what I'm saying is the danger of M is the payments now have really good likelihood of always take 24 hours or whatever it's not lightning fast anymore because it's sufficient that one single path is taking your time. So yeah so so you well I mean one thing you can do in lightning already is you can overpay it a little bit already to to office Kate some stuff right so you could say well I'm willing to overpay a little bit I have fees anyway so I make a couple paths more maybe a cent or something right and in this case if one path fails you'll see if you at some point times as well I have enough payment now I release the pre image right and with the rest whatever happens. So I mean for all of you yeah payment has currently in the suggestions yes but I think when we go with payment decorrelation and stuff we could also like come up with ideas but as I said before remember this picture right it's very often we can be very creative here but so if you currently think oh there might be a way of making different pre images right I mean you can simulate M already can already say hey I want to pay a merchant and I really trust that merchant right I don't trust the payment provider but I trust that merchant because the merchant sits in Australia because the merchant sits in Australia but what I'm saying is of course you could simulate M already and tell the merchant hey please give me one euro in one dollar invoices did you pay one invoice after a time right and if one of those got stuck you be like here come on now that right you you could do that technically and then you have different pre images so so there's many M proposals floating around as you know right and I think one of the reasons why many proposals are floating around is because nobody came up and said hey by the way this is a really good solution for path finding and everybody I said oh yeah we agree it's very obvious that this is a good solution let's go for it because we currently figure this out and as I said before that's a great opportunity for you having learned about all this stuff because you could actually work on these issues on the next slide I will show a small table to argue that it's not even clear if the likelihood for successful payment is higher when you split those payments so keep this for a second another disadvantage of M is you have more HTNCs and flight I think we discussed this yesterday they already in the room a little bit when you make more payments and those payments tend to be longer because you have to wait for the longest path more HTNCs and more payment channels are in use which could result in several things one thing is I think I have this as points here yes statistically we waste more block space if channels break because statistically speaking the chances higher that on this channels they are currently more HTNCs these HTNCs usually are also smaller the fees might eat up a lot of stuff and the channels might become overloaded so remember the channel can only have 483 HTNCs that's as you make really really really really small payments then we got it like eat up a lot of HTNCs so we have to think about it we want to do that I and for improvements for M I can't leave a refer to the talk of Alex that he already gave and his questions that we brought lines so so again I don't want to like say M is a bad idea but it has some problems and we should be aware of these problems right I promise to you to talk about and the the question if actually M has a higher chance of routing a payment and I have to say these are really completely arbitrary not cherry picked probabilities that I used in this one so what I did as I said well let's assume the probability of successful large payment is only 20% and the probability of a small payment is 80% and I don't even know what small and large actually means right but I thought 8020 rule is always a good thing to start with and again it's completely arbitrary so the M success probability is you take the probability of a small payment and this has to happen for every small payment right so you have to like basically compute this exponential and you ask the question is this really bigger than the probability of a large payment to fail and obviously better you do a simulation that you do whatever right I mean this is just a really rough thing sorry for the transition here you come up with this table so here this probability is always fixed and this is the number of parts that I would use in atomic multi-power for routing and obviously if I only do one part it's the same right for two parts I didn't go directly to 80% because it's still fairly large payment so I went to 0.4.6 and from there on I said it's always 0.8 probably it's like again I mean it's just rough numbers but what you can see is there's only a small window in which you actually get a higher probability with atomic multi-power routing in comparison to just use the standard large payment and in this small window don't take this series now because all the numbers are completely arbitrary choosing right but if you think about it it's not even clear it's counter arguments to what I'm currently presenting obviously right because this formula is not really true at a one-half phase where you just pull another one multi-power routing so eventually you might get it because you already have like a large fraction but there might be really constraints on the global view of the network that really in the you to to find a part even with atomic multi-power routing and it's not in clear when this fails. Okay so good routing um just in time routing it's the following idea let's let's say S1s to make a payment of 90s to talk to you to our and this is how network currently looks like right so S and B have a channel of a capacity of 110 to 10 torches and then another little bit small lighting but and S has the balance of arm with the torches and B has a channel with R which has a capacity of 200 but G only has 80 the torches on this channel and then B also has a channel with T also the capacity is 200 the the balance for B is 80 and then here's another channel which is even the value of everybody has 100 torches right so so what you can already see is when you probe this network you don't find a path because here you can't forward 90 and here you can't forward 90 and very obviously you can't live with M right you can just do a certain split in M and then you find the solution what what I'm trying to do in just a time routing is this picture so when the onion so so S selects this path over B to R that's the path that S is really crowbing and doing when B receives this onion B says I can forward this onion in a regular payment B would now send back an arrow and say I can't forward this onion all the HGLC score all the way back to S and nothing happens but B could now say well we do something and I think I wrote this down here sorry what what B could do is B could use one of the coolest tricks that we use in lightning what is the coolest trick that we use in lightning in general balancing yeah every balancing is the idea but but what is the concept what B does now or sending this out no okay I just give you the answer B is B is deferring the routing process to the future right and remember lightning referring publishing a bit consciousness action to the future was a good concept right so so we're doing the same here B says instead of sending back an arrow I do what you say you rebadence right so now B does circuit onion sending 50 Satoshi on this channel only having 30 now this one also move some capacity on the channel now there's around the 30 Satoshi's on the channel and what you can see the payment will through great well that count that count happened because the onion is already constructed that you just contain some redundant fees and so that others can do the zone I mean that's that's a question right I have different suggestions to mitigate this problem my suggestion is that I will still go on yeah okay I can't just in time because you get your liquidity that you need just in time like your supply chain concept what happens if I cancel the receiving of the payment if you can't solve it if I cancel my receiving I don't I don't accept it who are you in this graph now if I'm getting the payment and you do the just in time routing yeah but I just when the payment comes to me I just cancel I redacted well that's no big problem because if you read of the mailing list the person suggests that you can do the rebalancing with the same payment session and in that case the rebalancing only takes place if you accept the payments so you only pay fees for the rebalancing of the payment and in that case you still don't have enough capacity to go through the R because you already are here right I mean in that particular problem then I don't know because because if you if you bind the rebalancing to the same pre-image then the HLCs will not get resolved and you can't create a new HLC for 90 no but here since you have two HCCs in two directions they could have a protocol of mitigating this you could I'm not saying we should do it I'm saying you could but I even have a different suggestion for this so so in general my suggestion is the peers might want to admit the fees on the rebalancing operation okay so in general if you look at graph theory there is a certain amount of networks you should always look at when when you look at a graph so so there's one thing that is called your ego network that is if your B your ego network consists of ST and R but everybody who is around you and I mean that's that's the network that you usually know enlightening very well because you have your note and you know what's with your channels and your peers but what I would suggest is to look at your friend of a friend network so if I am S my friend of a friend network actually goes all the way to R because all the friends of my friends are in there and if you do the math you will realize that all circles of length five are in your friend of friend network so what if and that's a question what if we would argue and say you know what in your friend of a friend network we introduce another gossip query or another query of saying hey to all my peers give me your channel balances of all your channels right now and I have a very local view where I actually know the exact topology and I can suggest a rerouting the rebalancing route and I could even do a public right I could extend the bolt protocol and everybody on the shroud would say hey actually for each of one of us it's better to now shift these funds so now you can do the rebalancing for three you could right I'm not saying we should do it in this way but I mean this is one way of achieving this and if you compared with the privacy model of trampoline it might actually be a better privacy model and you don't have to do it as drastic as I'm suggesting this right now I mean you could also have a query of saying hey tell me channels on which you want to have inbound capacity or tell me channels on which you want to have outbound capacity I just continue so some considerations with it I think the idea got clear so the disadvantage is you need additional probing for the rebalancing operation it may be costly for routing notes right especially when you do it on the current system because you'll just have to pay fees and maybe even for the rebalancing use a different pre-emote because currently that's easier the CRTV data is currently might not be sufficient to support an additional routing operation because they're very tight on on time and you don't find a route that actually completely works on smaller CRTV data and it also increases the time because there is a time needed for rebalancing again as I mentioned one way of improving this is of creating this friend of a friend overlay network and maybe extend the gossip protocol here to exchange a little bit more information similarly in this like BGB setting we could use some aggregated information about channels to do this and we could do cost free search the roads in lightning especially if they are not encrypted you know that you can't use them for like the nanoservice text or something because you know who is involved all right multi-up trampoline payments so the high level idea I think we already so if you get the best effort component in you define a rough route if you do multi-trampulines where you say hey it should go through these trampolines and then let the nodes on the route figure out how to do the actual paths between the trampolines right so so again you shift this like path finding problem to those people who are along your route so I think yesterday the idea was was coming up but not very clear that it might make sense on lightning to to extend the gossip protocol that the trampoline nodes have like their own network of saying I'm pretty confident that I'm able to like over to Christian even though we're not direct peers or something like this so then on this like trampoline network I could make a route right somebody in the end was could say hey use this trampoline as an exception for the kind of this thing or in this way just advantage is that needs a protocol change currently we need this mix on the informants which is always a little bit and I think it's coming but we need it so yeah the only informant needs to adapt it a click of trampoline that is in my opinion more severe problem might emerge and build a cartel especially if we even enforce something like this on the protocol level so so there could be I think the question was already coming from the room a centralization or happened spoke to politics might emerge and the privacy model decreases a lot or subtrampling really no nodes I'm doing a payment to somebody else right or somebody's doing a payment to somebody else where's the majority of them you don't have this problem right the the person initiating the rebalancing just knows like before from where to where on the local view but not on the global view and I think yesterday we kind of figured out that it wouldn't work for all at least right now for all spontaneous payment protocols so for improvements I refer to talk to Christian and probably also to Kimory Nebastron okay so just to sum up some general thoughts on half finding I think we should acknowledge how I already did in the other talk that half finding is an open and difficult problem for the lightning network we should not ignore this and I personally think we should not wait to tackle this problem but I mean you could argue currently the lightning network is small and our current mechanism works but if we need to be a protocol changes for some of these ideas of or even other ideas then of course it might be too late once the lightning network is already widely spread so I think this is really problem we should like quickly work on various proposals and ideas exist some of them require protocol changes and different strategies could be combined I want to emphasize this right you could combine trampoline payments with jet routing with m you can combine m with jet you can you can do all of these right it's not like one algorithm wins maybe maybe does it again and there seems to be a trade of between these strategies right some have like more privacy of individual nodes or the ability of the network to solve the path finding problem like really like where do we want to stand on this and yeah I say lightning might want to copy some ideas from the autumn normal system space in particular I think it's really useful if we have this hierarchical address days or it's Christian suggested to have like a core open routing protocol on the base that always works and then creating encrypted layer on top of this like because this will just increase the success rate and not everybody is desperate to try to see anyway my personal opinion is that half finding as I mentioned before will emerge as a business model and opportunity because if we keep it with this current setup then people with third party services will definitely win because once you offer that service you easily might have more information than other nodes on the network and then you can offer better paths why do you have more information well I think it's similar to the google setting right everybody can now set out and write a web crawler and have like a view of the web graph but google or sorry google has all the lock files and the lock files are and crucial part piece of information that help google to make better search suggestions so I conclude my talk by saying half finding has many channels channel challenges so please think about them join us and take this problem serious
